name: Android Build Pipeline
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: memory-master

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt update -y
          sudo apt install -y \
            openjdk-17-jdk \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            pkg-config \
            libgl1-mesa-dev \
            gradle \
            tree

      - name: Verify files exist
        run: |
          cd memory-master
          echo "=== Checking required files ==="
          [ -f app.py ] && echo "app.py found" || { echo "ERROR: app.py missing"; exit 1; }
          [ -f words.txt ] && echo "words.txt found" || echo "WARNING: words.txt missing"
          [ -f correct.wav ] && echo "correct.wav found" || echo "WARNING: correct.wav missing"
          [ -f wrong.wav ] && echo "wrong.wav found" || echo "WARNING: wrong.wav missing"

      - name: Prepare project structure
        run: |
          cd memory-master
          echo "=== Creating project structure ==="
          mkdir -p memorymaster
          mv app.py memorymaster/ || exit 1
          [ -f words.txt ] && mv words.txt memorymaster/
          [ -f correct.wav ] && mv correct.wav memorymaster/
          [ -f wrong.wav ] && mv wrong.wav memorymaster/
          echo "MIT License" > LICENSE
          echo "=== Final structure ==="
          tree || ls -R

      - name: Build Android APK
        run: |
          cd memory-master
          export GRADLE_OPTS="-Dorg.gradle.daemon=false"
          briefcase create android
          briefcase build android -v
          mkdir -p dist
          find android -name "*.apk" -exec cp {} dist/ \;

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: memory-master/dist/*.apk
          retention-days: 7

      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            memory-master/android/build/reports/**/*
            memory-master/*.log
          retention-days: 3
